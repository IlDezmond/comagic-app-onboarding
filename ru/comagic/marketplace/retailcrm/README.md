### Интеграция с RetailCRM

**Ценность**  

Решение позволяет передавать в наш кабинет данные по сделкам, для дальнейшего построения Сквозной аналитики.

**Какие данные передаются**

- сделки: сумма сделки, статус, магазин, к которому относится сделка и тд; 
- воронка продаж и ее этапы;
- контакты;
- ответственный менеджер.  

**Необходимые компоненты для работы интеграции**  
- Сквозная аналитика.

### Подключение интеграции 

Интеграция подключается в несколько шагов:

1. Нажмите "Активен" на этой странице.
2. Заполните поля/проставьте требуемые маркеры в настройках.  

**Авторизация в RetailCRM**

Добавьте:
- URL (домен RetailCRM ) в формате https://shop472.retailcrm.ru/ , часть 'shop472' у каждого клиента уникальна
- API key - ключ API RetailCRM, Настройки - > Интеграция → Ключи доступа к API -> Добавить
Создаем новый ключ, с доступом ко всем магазинам и методам. Добавляем данный ключ в настройки интеграции.

![image](retailcrm_auth.gif)

 
**Маркеры:**
- **Дефолтная воронка** - при прожатии все сделки будут передаваться в 1 воронку по умолчанию. В противном случае по каждом магазину будет создана отдельная воронка. 
- **Учитывать стоимость доставки** - при прожатии в сумму сделки будет включена стоимость доставки.

3. Создайте триггер в RetailCRM на Webhook url сервиса CoMagic/UIS из настроек. 

Автоматизация → Триггеры →  Добавить триггер
Заполняем настройки триггера:

- название 
- добавляем событие 'Изменение заказа ': 
  - обязательно указываем в условиях:  "Новый заказ" или  "Изменение статуса заказа с Любой на Любой" или "Заказ оплачен "Да"
  - в действие добавляем "Выполнить HTTP-запрос"  , в нем заполняем настройки :
     - Адрес  - Webhook url из настроек интеграции
     - HTTP метод - GET
     - Передавать параметры - в теле запроса  
       Параметр: orderId  
       Значение: {{ order.id }}

![image](retail_trigger_2.gif)

4. Нажмите сохранить.


После подключения интеграции сделки будут попадать в  Сырые данные -> Сделки.  
Для проверки корректности работы интеграции создайте тестовую сделку в RetailCRM.
